name: Database Sync

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Sync mode'
        required: true
        default: 'snapshot'
        type: choice
        options:
          - snapshot
          - full-sync
          - schema-only

jobs:
  sync-snapshot:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'snapshot'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Supabase CLI
        run: |
          # Install via npm
          npm install -g @supabase/cli

      - name: Configure Supabase
        run: |
          supabase login --token ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Generate schema snapshot
        run: |
          mkdir -p db/schema
          supabase db dump --linked --schema-only > db/schema/schema.sql
          supabase db dump --linked --data-only > db/data/latest.sql

      - name: Create pull request with changes
        uses: peter-evans/create-pull-request@v7
        with:
          title: "chore: Update database snapshot $(date +%Y-%m-%d)"
          body: "Automated database schema snapshot from production"
          commit-message: "chore: Update database schema snapshot $(date +%Y-%m-%d)"
          branch: "db-snapshot-$(date +%Y-%m-%d)"
          delete-branch: true

  sync-full:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'full-sync'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Supabase CLI
        run: |
          npm install -g @supabase/cli

      - name: Configure Supabase
        run: |
          supabase login --token ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Generate full database dump
        run: |
          mkdir -p db/schema db/data db/scripts
          supabase db dump --linked --schema-only > db/schema/production_schema.sql
          supabase db dump --linked --data-only > db/data/production_data.sql

      - name: Create restore script
        run: |
          cat > db/scripts/restore-from-production.md << 'EOF'
          # Restore Local Database from Production

          ## Quick Start

          1. Download artifact from GitHub Actions run
          2. Extract to db/ folder
          3. Run: 
             ```
             PGPASSWORD=postgres psql -h localhost -U postgres -d postgres < db/data/production_data.sql
             ```

          ## Full Steps

          ### Step 1: Download artifact
          - Go to GitHub Actions → Database Sync → latest run
          - Download "production-database-dump" artifact
          - Extract to project root

          ### Step 2: Restore to local database
          ```bash
          cd ~/supabase-local
          docker compose down
          docker volume rm supabase-local_pgdata
          docker compose up -d
          sleep 5

          # Apply schema
          PGPASSWORD=postgres psql -h localhost -U postgres -d postgres -f db/schema/production_schema.sql

          # Import data
          PGPASSWORD=postgres psql -h localhost -U postgres -d postgres < db/data/production_data.sql
          ```

          ## Safety Notes
          ⚠️ Never run on production!
          ✅ Safe for local development only
          EOF

      - name: Upload database dump as artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-database-dump
          path: |
            db/schema/
            db/data/
            db/scripts/restore-from-production.md
          retention-days: 7

      - name: Create pull request with dump
        uses: peter-evans/create-pull-request@v7
        with:
          title: "chore: Production database dump $(date +%Y-%m-%d)"
          body: "Full database dump for local development"
          commit-message: "chore: Add production database dump $(date +%Y-%m-%d)"
          branch: "db-dump-$(date +%Y-%m-%d)"
          delete-branch: true
          add-paths: |
            db/schema/production_schema.sql
            db/data/production_data.sql
            db/scripts/restore-from-production.md

  schema-only:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'schema-only'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Validate schema files
        run: |
          echo "Checking migrations..."
          ls -la db/migrations/

          echo ""
          echo "Checking schema files..."
          ls -la db/schema/

          echo ""
          echo "Checking scripts..."
          ls -la db/scripts/*.sh

          echo ""
          echo "Validation complete!"

  snapshot-daily:
    # Runs daily at 6 AM UTC (no manual trigger needed)
    # Just creates schema snapshot without push
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Supabase CLI
        run: npm install -g @supabase/cli

      - name: Generate schema snapshot
        run: |
          mkdir -p db/schema
          supabase db dump --linked --schema-only > db/schema/schema.sql
          echo "Schema snapshot generated"
          cat db/schema/schema.sql | head -20

      - name: Upload schema as artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily-schema-snapshot
          path: db/schema/schema.sql
          retention-days: 1
