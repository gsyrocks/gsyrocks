name: Database Sync

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Sync mode'
        required: true
        default: 'snapshot'
        type: choice
        options:
          - snapshot
          - full-sync
          - schema-only

env:
  SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}

jobs:
  snapshot:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'snapshot'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Generate schema snapshot
        run: |
          mkdir -p db/schema
          echo "Connection string starts with: ${SUPABASE_DB_URL:0:50}..."
          
          # Parse connection string and use explicit flags
          # Format: postgresql://postgres:password@host:5432/postgres
          IFS='@' read -r user_part host_part <<< "$SUPABASE_DB_URL"
          IFS=':' read -r user password <<< "${user_part#postgresql://}"
          IFS=':' read -r host port_db <<< "$host_part"
          IFS='/' read -r port dbname <<< "$port_db"
          
          echo "Host: $host"
          echo "Port: $port"
          echo "Database: $dbname"
          
          pg_dump "postgresql://$user:$password@$host:$port/$dbname" --schema-only --no-owner > db/schema/schema.sql
          echo "Schema snapshot created"
          wc -l db/schema/schema.sql

      - name: Create pull request
        uses: peter-evans/create-pull-request@v7
        with:
          title: "chore: Database schema snapshot $(date +%Y-%m-%d)"
          body: "Automated schema snapshot from production Supabase"
          commit-message: "chore: Update database schema $(date +%Y-%m-%d)"
          branch: "db-snapshot-$(date +%Y-%m-%d)"
          delete-branch: true

  full-sync:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'full-sync'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Generate full database dump
        run: |
          mkdir -p db/schema db/data db/scripts
          
          # Parse connection string
          IFS='@' read -r user_part host_part <<< "$SUPABASE_DB_URL"
          IFS=':' read -r user password <<< "${user_part#postgresql://}"
          IFS=':' read -r host port_db <<< "$host_part"
          IFS='/' read -r port dbname <<< "$port_db"
          
          pg_dump "postgresql://$user:$password@$host:$port/$dbname" --schema-only --no-owner > db/schema/production_schema.sql
          pg_dump "postgresql://$user:$password@$host:$port/$dbname" --data-only --no-owner > db/data/production_data.sql
          echo "Schema: $(wc -l < db/schema/production_schema.sql) lines"
          echo "Data: $(wc -l < db/data/production_data.sql) lines"

      - name: Create restore script
        run: |
          cat > db/scripts/restore-from-production.md << 'EOF'
          # Restore Local Database from Production

          ## Download Artifact
          1. Go to GitHub Actions → Database Sync → latest run
          2. Download "production-database-dump" artifact
          3. Extract to project root

          ## Restore Commands
          ```bash
          cd ~/supabase-local
          docker compose down
          docker volume rm supabase-local_pgdata
          docker compose up -d
          sleep 5

          PGPASSWORD=postgres psql -h localhost -U postgres -d postgres -f db/schema/production_schema.sql
          PGPASSWORD=postgres psql -h localhost -U postgres -d postgres < db/data/production_data.sql
          ```

          ## Safety Notes
          ⚠️ Only run on local development!
          EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-database-dump
          path: |
            db/schema/
            db/data/
            db/scripts/
          retention-days: 7

      - name: Create pull request
        uses: peter-evans/create-pull-request@v7
        with:
          title: "chore: Production database dump $(date +%Y-%m-%d)"
          body: "Full database dump for local development"
          commit-message: "chore: Add production dump $(date +%Y-%m-%d)"
          branch: "db-dump-$(date +%Y-%m-%d)"
          delete-branch: true

  schema-only:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'schema-only'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Validate schema files
        run: |
          echo "=== Migrations ==="
          ls -la db/migrations/ 2>/dev/null || echo "No migrations folder"
          echo ""
          echo "=== Schema ==="
          ls -la db/schema/ 2>/dev/null || echo "No schema folder"
          echo ""
          echo "=== Scripts ==="
          ls -la db/scripts/*.sh 2>/dev/null || echo "No scripts"
          echo ""
          echo "✓ Validation complete"
